# Financial Reports Application

## Overview
The Financial Reports Application is a web-based platform designed to manage financial reports for clients. It provides an admin panel for managing clients, projects, and payments, as well as a client dashboard for viewing financial reports.

## Project Structure
```
financial-reports-app
‚îú‚îÄ‚îÄ css
‚îÇ   ‚îî‚îÄ‚îÄ style.css        # Contains styles for the application
‚îú‚îÄ‚îÄ js
‚îÇ   ‚îî‚îÄ‚îÄ script.js        # Contains JavaScript code for application logic
‚îú‚îÄ‚îÄ index.html           # Main HTML file for the application
‚îî‚îÄ‚îÄ README.md            # Documentation for the project
```

## Getting Started

### Prerequisites
- A modern web browser (Chrome, Firefox, Safari, etc.)
- Basic knowledge of HTML, CSS, and JavaScript

### Installation
1. Clone the repository or download the project files.
2. Open the `index.html` file in your web browser.

### Usage
- **Admin Login**: Use the credentials `admin@finreport.co` / `password123` to log in to the admin panel.
- **Client Dashboard**: Clients can access their financial reports via a unique token link generated by the admin.

### Features
- Admin panel for managing clients, projects, and payments.
- Client dashboard for viewing financial summaries and reports.
- Responsive design using Tailwind CSS.
- Print functionality for generating PDF reports.

### Contributing
Contributions are welcome! Please feel free to submit a pull request or open an issue for any suggestions or improvements.

### License
This project is licensed under the MIT License. See the LICENSE file for more details.

# FinReport Pro - Plataforma de Reportes Financieros

Este proyecto es una Single Page Application (SPA) para la gesti√≥n de clientes y la generaci√≥n de reportes financieros. Permite a un administrador gestionar clientes y generar enlaces de acceso temporal para que los clientes vean el estado de sus proyectos y pagos.

---

## üìù Actualizaciones y Changelog

Aqu√≠ se registrar√°n todos los cambios importantes, nuevas funcionalidades y correcciones.

### v1.0.1 - 31 de octubre de 2025
*   **Correcci√≥n (Bug Fix):** Se corrigi√≥ un error visual en el panel de administraci√≥n donde las vistas de "Proyectos" y "Pagos" mostraban los datos en formato JSON crudo en lugar de tablas formateadas.

### v1.0.0 - 31 de octubre de 2025
*   **Refactorizaci√≥n Inicial:** Se separa el c√≥digo monol√≠tico en una estructura de archivos organizada (`index.html`, `css/style.css`, `js/script.js`).
*   **Funcionalidad Base:**
    *   M√≥dulo de autenticaci√≥n para administradores.
    *   Panel de administraci√≥n con CRUD para Clientes.
    *   Generaci√≥n de tokens de acceso temporal (simulados con Base64) para reportes de clientes.
    *   Dashboard de cliente para visualizar proyectos, pagos y un resumen financiero.
    *   Sistema de logging para auditor√≠a de acciones importantes.
    *   Funcionalidad de impresi√≥n (Generar PDF) para el reporte del cliente.

---

## üêû Bugs Cr√≠ticos Conocidos

Actualmente no hay bugs cr√≠ticos conocidos.

*   _(Aqu√≠ se listar√°n los bugs urgentes que necesitan atenci√≥n inmediata)_

---

## ‚úÖ Tareas Pendientes (To-Do)

Lista de funcionalidades y mejoras planificadas para futuras versiones.

### Backend y Seguridad
- [ ] Implementar un backend real (Node.js, Python, etc.) para gestionar la base de datos de forma segura.
- [ ] Reemplazar la codificaci√≥n Base64 por verdaderos JSON Web Tokens (JWT) con firma digital.
- [ ] Crear endpoints de API seguros para todas las operaciones CRUD.

### Funcionalidades del Administrador
- [ ] Desarrollar el CRUD completo para **Proyectos**.
- [ ] Desarrollar el CRUD completo para **Pagos**.
- [ ] A√±adir filtros y b√∫squeda en las tablas de Clientes, Proyectos y Pagos.
- [ ] Implementar paginaci√≥n para las listas largas (clientes, logs, etc.).

### Funcionalidades del Cliente
- [ ] Integrar una pasarela de pago real (Stripe, PayPal) para que los clientes puedan pagar saldos pendientes directamente desde su dashboard.
- [ ] A√±adir una secci√≥n para descargar facturas en formato PDF.
- [ ] Mejorar la interfaz de usuario del reporte del cliente con gr√°ficos interactivos (ej. Chart.js).

### Mejoras Generales
- [ ] Escribir pruebas unitarias para las funciones cr√≠ticas (autenticaci√≥n, c√°lculos financieros, etc.).
- [ ] Mejorar la validaci√≥n de formularios tanto en el cliente como en el servidor.

üìù Documentaci√≥n SQL (DDL) de la Estructura de Tablas
Aqu√≠ tienes las sentencias CREATE TABLE para documentar la estructura de tus tablas en el esquema public.

1. Tabla clients (Clientes)
Esta tabla almacena la informaci√≥n de los clientes.

```sql

CREATE TABLE public.clients (
    -- Clave Primaria (PK) y Autoincremental
    id bigint PRIMARY KEY GENERATED BY DEFAULT AS IDENTITY,
    
    -- Informaci√≥n del Cliente
    name character varying NOT NULL,
    email character varying NOT NULL,
    
    -- Metadatos de Fecha
    created_at timestamp with time zone DEFAULT timezone('utc'::text, now()),
    updated_at timestamp with time zone 
);
```
2. Tabla projects (Proyectos)
Esta tabla registra los proyectos asociados a un cliente (clientId).

```sql

CREATE TABLE public.projects (
    -- Clave Primaria (PK) y Autoincremental
    id bigint PRIMARY KEY GENERATED BY DEFAULT AS IDENTITY,
    
    -- Columna para la Clave For√°nea (FK) - Relaci√≥n 1:N con clients.id
    clientId bigint, -- Asumiremos una FK aqu√≠, se a√±adir√° la restricci√≥n despu√©s.
    
    -- Informaci√≥n del Proyecto
    name character varying NOT NULL,
    description text,
    "totalValue" numeric NOT NULL, -- "totalValue" es case-sensitive por el formato
    status text NOT NULL DEFAULT 'activo'::text,
    
    -- Fechas de Proyecto
    start_date date,
    end_date date,
    
    -- Metadatos de Fecha
    created_at timestamp with time zone DEFAULT timezone('utc'::text, now()),
    updated_at timestamp with time zone
);
```

3. Tabla payments (Pagos)
Esta tabla almacena los registros de pagos, presumiblemente ligados a un proyecto (projectId).

```sql

CREATE TABLE public.payments (
    -- Clave Primaria (PK) y Autoincremental
    id bigint PRIMARY KEY GENERATED BY DEFAULT AS IDENTITY,
    
    -- Columna para la Clave For√°nea (FK) - Relaci√≥n 1:N con projects.id
    "projectId" bigint, -- "projectId" es case-sensitive por el formato
    
    -- Informaci√≥n del Pago
    amount numeric NOT NULL,
    payment_date date NOT NULL,
    status character varying NOT NULL DEFAULT 'revisi√≥n'::character varying,
    details text,
    
    -- Metadatos de Fecha
    created_at timestamp with time zone DEFAULT timezone('utc'::text, now())
);
```
4. Tabla access_tokens (Tokens de Acceso)
Esta tabla probablemente se usa para la autenticaci√≥n o acceso a la API.

```sql

CREATE TABLE public.access_tokens (
    -- Clave Primaria (PK) y Autoincremental
    token_id bigint PRIMARY KEY GENERATED BY DEFAULT AS IDENTITY,
    
    -- Columna para la Clave For√°nea (FK) - Presumiblemente a clients.id
    client_id bigint, -- Asumiremos una FK aqu√≠, se a√±adir√° la restricci√≥n despu√©s.
    
    -- Detalles del Token
    token_value text NOT NULL,
    expires_at timestamp with time zone NOT NULL,
    
    -- Metadatos de Fecha
    created_at timestamp with time zone DEFAULT timezone('utc'::text, now())
);
```
5. Tabla logs (Registros)
Esta tabla se utiliza para el seguimiento de acciones o eventos.

```sql
CREATE TABLE public.logs (
    -- Clave Primaria (PK) y Autoincremental
    log_id bigint PRIMARY KEY GENERATED BY DEFAULT AS IDENTITY,
    
    -- Detalles del Log
    user_id text,
    action_type character varying NOT NULL,
    description text,
    
    -- Metadatos de Fecha
    "timestamp" timestamp with time zone DEFAULT timezone('utc'::text, now())
);
```

## üîë Restricciones de Clave For√°nea (FK) y Relaciones

Las siguientes sentencias SQL definen las **relaciones** entre las tablas y especifican la acci√≥n a realizar cuando se elimina un registro de la tabla referenciada (la tabla "padre").

| Relaci√≥n | Columna de Origen | Tabla de Referencia | Acci√≥n `ON DELETE` | Explicaci√≥n |
| :--- | :--- | :--- | :--- | :--- |
| **FK Cliente** (Proyectos) | `projects.clientId` | `clients.id` | **SET NULL** | Si se elimina un cliente, la columna `clientId` en la tabla `projects` se establecer√° en `NULL`. |
| **FK Proyecto** (Pagos) | `payments."projectId"` | `projects.id` | **SET NULL** | Si se elimina un proyecto, la columna `"projectId"` en la tabla `payments` se establecer√° en `NULL`. |
| **FK Cliente** (Tokens) | `access_tokens.client_id` | `clients.id` | **CASCADE** | Si se elimina un cliente, **todos** los *tokens* de acceso asociados en la tabla `access_tokens` se eliminar√°n autom√°ticamente. |

---

### Sentencias DDL para Definir las Relaciones

Esta secci√≥n documenta c√≥mo se crearon estas restricciones. Si el esquema se recreara, estas sentencias (`ALTER TABLE`) deben ejecutarse despu√©s de que todas las tablas (`clients`, `projects`, `payments`, `access_tokens`, etc.) ya existan.

```sql
-- 1. Relaci√≥n Projects -> Clients
-- Conecta la columna "clientId" de projects con el "id" de clients.
-- ON DELETE SET NULL: Permite que un proyecto exista sin cliente.
ALTER TABLE public.projects
ADD CONSTRAINT fk_client
FOREIGN KEY ("clientId")
REFERENCES public.clients(id)
ON DELETE SET NULL;

-- 2. Relaci√≥n Payments -> Projects
-- Conecta la columna "projectId" de payments con el "id" de projects.
-- ON DELETE SET NULL: Permite que el registro de un pago persista sin su proyecto asociado (aunque con el campo "projectId" nulo).
ALTER TABLE public.payments
ADD CONSTRAINT fk_project_payment
FOREIGN KEY ("projectId")
REFERENCES public.projects(id)
ON DELETE SET NULL;

-- 3. Relaci√≥n Access Tokens -> Clients
-- Conecta la columna "client_id" de access_tokens con el "id" de clients.
-- ON DELETE CASCADE: Asegura que todos los tokens de un cliente se borren si el cliente es eliminado.
ALTER TABLE public.access_tokens
ADD CONSTRAINT fk_client_token
FOREIGN KEY (client_id)
REFERENCES public.clients(id)
ON DELETE CASCADE;
```

## üöÄ Edge Function: `payments-crud` (API RESTful)

Peque√±a API RESTful para gestionar la tabla `payments` en Supabase. Esta funci√≥n usa la clave de rol de servicio (`SUPABASE_SERVICE_ROLE_KEY`) y debe desplegarse con permisos expl√≠citos en Deno.

### 1. Resumen
- Endpoint (Functions v1): `https://<PROJECT_REF>.supabase.co/functions/v1/payments-crud`
- Autenticaci√≥n: Usar la clave de servicio en el header `Authorization: Bearer <SERVICE_ROLE_KEY>` (esta clave debe mantenerse en el servidor, no en el cliente).
- Tipos de contenido: `application/json`

---

### 2. Variables de entorno
La funci√≥n utiliza estas variables de entorno (ya definidas por Supabase):
- `SUPABASE_URL`
- `SUPABASE_SERVICE_ROLE_KEY`

---

### 3. Despliegue (CLI de Supabase)
Para evitar errores por permisos de Deno (acceso a env y a la red), despliega con las banderas indicadas. Reemplaza `<PROJECT_REF>` por el ref de tu proyecto:

```bash
supabase functions deploy payments-crud \
  --no-verify-jwt \
  --allow-env \
  --allow-net="<PROJECT_REF>.supabase.co,cdn.skypack.dev"
```

Nota: s√≥lo use `cdn.skypack.dev` si su funci√≥n importa desde ese host. Si no, om√≠talo para restringir permisos.

---

### 4. Estructura del objeto `payment` (JSON)
Campos esperados para POST/PUT:

```json
{
  "id": number,            // Requerido s√≥lo para PUT/DELETE
  "projectId": number,     // required (POST)
  "amount": number,        // required (POST)
  "payment_date": "YYYY-MM-DD", // required (POST)
  "details": "string|null",// optional
  "status": "Pendiente|Completado|..." // required (POST)
}
```

Campos controlados por la DB (no enviar en POST): `created_at`, `id` (si DB genera autoincrement).

---

### 5. Cabeceras obligatorias
- Content-Type: application/json
- Authorization: Bearer <SERVICE_ROLE_KEY> (o la clave que uses para la funci√≥n)

---

### 6. M√©todos soportados (CRUD) y ejemplos

- Leer todos los pagos ‚Äî GET  
  Request: GET sin body  
  Respuesta: 200 OK ‚Äî JSON array de objetos `payment`.

  Ejemplo curl:
  ```bash
  curl -X GET "https://<PROJECT_REF>.supabase.co/functions/v1/payments-crud" \
    -H "Authorization: Bearer <SERVICE_ROLE_KEY>"
  ```

- Crear un pago ‚Äî POST  
  Request: JSON con campos necesarios. Respuesta: 201 Created

  Body ejemplo:
  ```json
  {
    "projectId": 1,
    "amount": 40.00,
    "payment_date": "2025-11-01",
    "details": "Pago inicial de la factura 1234",
    "status": "Pendiente"
  }
  ```

  Ejemplo curl:
  ```bash
  curl -X POST "https://<PROJECT_REF>.supabase.co/functions/v1/payments-crud" \
    -H "Authorization: Bearer <SERVICE_ROLE_KEY>" \
    -H "Content-Type: application/json" \
    -d '{"projectId":1,"amount":40,"payment_date":"2025-11-01","details":"Pago inicial","status":"Pendiente"}'
  ```

- Actualizar un pago ‚Äî PUT  
  Request: JSON que incluya `id` y los campos a actualizar. Respuesta: 200 OK

  Body ejemplo:
  ```json
  {
    "id": 42,
    "amount": 60.50,
    "status": "Completado"
  }
  ```

  Ejemplo curl:
  ```bash
  curl -X PUT "https://<PROJECT_REF>.supabase.co/functions/v1/payments-crud" \
    -H "Authorization: Bearer <SERVICE_ROLE_KEY>" \
    -H "Content-Type: application/json" \
    -d '{"id":42,"amount":60.5,"status":"Completado"}'
  ```

- Eliminar un pago ‚Äî DELETE  
  Request: JSON con `id`. Respuesta: 200 OK

  Body ejemplo:
  ```json
  { "id": 42 }
  ```

  Ejemplo curl:
  ```bash
  curl -X DELETE "https://<PROJECT_REF>.supabase.co/functions/v1/payments-crud" \
    -H "Authorization: Bearer <SERVICE_ROLE_KEY>" \
    -H "Content-Type: application/json" \
    -d '{"id":42}'
  ```

---

### 7. Errores comunes y soluci√≥n r√°pida
- "Unexpected end of JSON input": el body de la request est√° vac√≠o o no es JSON v√°lido.  
  - Verifica que `Content-Type: application/json` est√© presente.  
  - Asegura que el body no est√© vac√≠o y sea JSON v√°lido (Thunder Client ‚Üí Body ‚Üí Raw JSON).

- Errores de import/permiso en el deploy: a√±ade `--allow-env` y `--allow-net` al comando de deploy, o evita importaciones desde CDNs que requieran permiso de red.

---
