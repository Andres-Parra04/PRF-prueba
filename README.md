# Financial Reports Application

## Overview
The Financial Reports Application is a web-based platform designed to manage financial reports for clients. It provides an admin panel for managing clients, projects, and payments, as well as a client dashboard for viewing financial reports.

## Project Structure
```
financial-reports-app
‚îú‚îÄ‚îÄ css
‚îÇ   ‚îî‚îÄ‚îÄ style.css        # Contains styles for the application
‚îú‚îÄ‚îÄ js
‚îÇ   ‚îî‚îÄ‚îÄ script.js        # Contains JavaScript code for application logic
‚îú‚îÄ‚îÄ index.html           # Main HTML file for the application
‚îî‚îÄ‚îÄ README.md            # Documentation for the project
```

## Getting Started

### Prerequisites
- A modern web browser (Chrome, Firefox, Safari, etc.)
- Basic knowledge of HTML, CSS, and JavaScript

### Installation
1. Clone the repository or download the project files.
2. Open the `index.html` file in your web browser.

### Usage
- **Admin Login**: Use the credentials `admin@finreport.co` / `password123` to log in to the admin panel.
- **Client Dashboard**: Clients can access their financial reports via a unique token link generated by the admin.

### Features
- Admin panel for managing clients, projects, and payments.
- Client dashboard for viewing financial summaries and reports.
- Responsive design using Tailwind CSS.
- Print functionality for generating PDF reports.

### Contributing
Contributions are welcome! Please feel free to submit a pull request or open an issue for any suggestions or improvements.

### License
This project is licensed under the MIT License. See the LICENSE file for more details.

# FinReport Pro - Plataforma de Reportes Financieros

Este proyecto es una Single Page Application (SPA) para la gesti√≥n de clientes y la generaci√≥n de reportes financieros. Permite a un administrador gestionar clientes y generar enlaces de acceso temporal para que los clientes vean el estado de sus proyectos y pagos.

---

## üìù Actualizaciones y Changelog

Aqu√≠ se registrar√°n todos los cambios importantes, nuevas funcionalidades y correcciones.

### v1.0.1 - 31 de octubre de 2025
*   **Correcci√≥n (Bug Fix):** Se corrigi√≥ un error visual en el panel de administraci√≥n donde las vistas de "Proyectos" y "Pagos" mostraban los datos en formato JSON crudo en lugar de tablas formateadas.

### v1.0.0 - 31 de octubre de 2025
*   **Refactorizaci√≥n Inicial:** Se separa el c√≥digo monol√≠tico en una estructura de archivos organizada (`index.html`, `css/style.css`, `js/script.js`).
*   **Funcionalidad Base:**
    *   M√≥dulo de autenticaci√≥n para administradores.
    *   Panel de administraci√≥n con CRUD para Clientes.
    *   Generaci√≥n de tokens de acceso temporal (simulados con Base64) para reportes de clientes.
    *   Dashboard de cliente para visualizar proyectos, pagos y un resumen financiero.
    *   Sistema de logging para auditor√≠a de acciones importantes.
    *   Funcionalidad de impresi√≥n (Generar PDF) para el reporte del cliente.

---

## üêû Bugs Cr√≠ticos Conocidos

Actualmente no hay bugs cr√≠ticos conocidos.

*   _(Aqu√≠ se listar√°n los bugs urgentes que necesitan atenci√≥n inmediata)_

---

## ‚úÖ Tareas Pendientes (To-Do)

Lista de funcionalidades y mejoras planificadas para futuras versiones.

### Backend y Seguridad
- [ ] Implementar un backend real (Node.js, Python, etc.) para gestionar la base de datos de forma segura.
- [ ] Reemplazar la codificaci√≥n Base64 por verdaderos JSON Web Tokens (JWT) con firma digital.
- [ ] Crear endpoints de API seguros para todas las operaciones CRUD.

### Funcionalidades del Administrador
- [ ] Desarrollar el CRUD completo para **Proyectos**.
- [ ] Desarrollar el CRUD completo para **Pagos**.
- [ ] A√±adir filtros y b√∫squeda en las tablas de Clientes, Proyectos y Pagos.
- [ ] Implementar paginaci√≥n para las listas largas (clientes, logs, etc.).

### Funcionalidades del Cliente
- [ ] Integrar una pasarela de pago real (Stripe, PayPal) para que los clientes puedan pagar saldos pendientes directamente desde su dashboard.
- [ ] A√±adir una secci√≥n para descargar facturas en formato PDF.
- [ ] Mejorar la interfaz de usuario del reporte del cliente con gr√°ficos interactivos (ej. Chart.js).

### Mejoras Generales
- [ ] Escribir pruebas unitarias para las funciones cr√≠ticas (autenticaci√≥n, c√°lculos financieros, etc.).
- [ ] Mejorar la validaci√≥n de formularios tanto en el cliente como en el servidor.


# üóÑÔ∏è Esquema de Base de Datos

El proyecto utiliza **PostgreSQL** a trav√©s de **Supabase DB**. El esquema ha sido dise√±ado para centralizar la gesti√≥n de clientes, proyectos, pagos y el registro de actividad, facilitando el sistema de reportes financieros y el acceso mediante tokens temporales.

---

## üíæ Scripts de Creaci√≥n (Supabase/PostgreSQL)

El siguiente script define todas las tablas necesarias, incluyendo claves primarias (`PK`), claves for√°neas (`FK`) y las restricciones de unicidad (`UNIQUE`).

```sql
-- Creaci√≥n de la base de datos para Plataforma de Reportes Financieros para Clientes

-- 1. Tabla: clients (clientes)
CREATE TABLE clients (
    client_id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    name VARCHAR(255) NOT NULL,
    email VARCHAR(255) UNIQUE NOT NULL, -- Email para env√≠o de links temporales
    created_at TIMESTAMP WITH TIME ZONE DEFAULT timezone('utc'::text, now()),
    updated_at TIMESTAMP WITH TIME ZONE
);

-- 2. Tabla: projects (proyectos)
CREATE TABLE projects (
    project_id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    client_id UUID REFERENCES clients(client_id) ON DELETE CASCADE, -- Relaci√≥n con la tabla clients
    name VARCHAR(255) NOT NULL,
    description TEXT,
    total_amount NUMERIC(10, 2) NOT NULL,
    status TEXT NOT NULL DEFAULT 'activo', -- Criterio de aceptaci√≥n: (activos/cerrados)
    start_date DATE,
    end_date DATE,
    created_at TIMESTAMP WITH TIME ZONE DEFAULT timezone('utc'::text, now()),
    updated_at TIMESTAMP WITH TIME ZONE
);

-- 3. Tabla: payments (pagos)
CREATE TABLE payments (
    payment_id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    project_id UUID REFERENCES projects(project_id) ON DELETE CASCADE, -- Relaci√≥n con la tabla projects
    amount NUMERIC(10, 2) NOT NULL,
    payment_date DATE NOT NULL,
    details TEXT,
    created_at TIMESTAMP WITH TIME ZONE DEFAULT timezone('utc'::text, now())
);

-- 4. Tabla: access_tokens (tokens de acceso temporal)
-- Usada para la autenticaci√≥n del cliente (link temporal de 24h).
CREATE TABLE access_tokens (
    token_id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    client_id UUID REFERENCES clients(client_id) ON DELETE CASCADE,
    token_value TEXT UNIQUE NOT NULL, -- Clave √∫nica y no nula para el enlace
    expires_at TIMESTAMP WITH TIME ZONE NOT NULL, -- La expiraci√≥n debe ser validada (24 horas)
    created_at TIMESTAMP WITH TIME ZONE DEFAULT timezone('utc'::text, now())
);

-- 5. Tabla: logs (registro de actividad)
CREATE TABLE logs (
    log_id BIGINT PRIMARY KEY GENERATED ALWAYS AS IDENTITY, -- ID autoincremental
    user_id UUID, -- ID del administrador (referencia a la tabla auth.users de Supabase)
    action_type VARCHAR(100) NOT NULL, -- Ej: 'LOGIN', 'CREATE_CLIENT', 'GENERATE_LINK'
    description TEXT,
    timestamp TIMESTAMP WITH TIME ZONE DEFAULT timezone('utc'::text, now())
);

-- √çndices para optimizar consultas:
CREATE INDEX idx_projects_client_id ON projects(client_id);
CREATE INDEX idx_payments_project_id ON payments(project_id);
CREATE INDEX idx_access_tokens_client_id ON access_tokens(client_id);
CREATE INDEX idx_logs_timestamp ON logs(timestamp);
```
## üöÄ Edge Function: `payments-crud` (API RESTful)

Peque√±a API RESTful para gestionar la tabla `payments` en Supabase. Esta funci√≥n usa la clave de rol de servicio (`SUPABASE_SERVICE_ROLE_KEY`) y debe desplegarse con permisos expl√≠citos en Deno.

### 1. Resumen
- Endpoint (Functions v1): `https://<PROJECT_REF>.supabase.co/functions/v1/payments-crud`
- Autenticaci√≥n: Usar la clave de servicio en el header `Authorization: Bearer <SERVICE_ROLE_KEY>` (esta clave debe mantenerse en el servidor, no en el cliente).
- Tipos de contenido: `application/json`

---

### 2. Variables de entorno
La funci√≥n utiliza estas variables de entorno (ya definidas por Supabase):
- `SUPABASE_URL`
- `SUPABASE_SERVICE_ROLE_KEY`

---

### 3. Despliegue (CLI de Supabase)
Para evitar errores por permisos de Deno (acceso a env y a la red), despliega con las banderas indicadas. Reemplaza `<PROJECT_REF>` por el ref de tu proyecto:

```bash
supabase functions deploy payments-crud \
  --no-verify-jwt \
  --allow-env \
  --allow-net="<PROJECT_REF>.supabase.co,cdn.skypack.dev"
```

Nota: s√≥lo use `cdn.skypack.dev` si su funci√≥n importa desde ese host. Si no, om√≠talo para restringir permisos.

---

### 4. Estructura del objeto `payment` (JSON)
Campos esperados para POST/PUT:

```json
{
  "id": number,            // Requerido s√≥lo para PUT/DELETE
  "projectId": number,     // required (POST)
  "amount": number,        // required (POST)
  "payment_date": "YYYY-MM-DD", // required (POST)
  "details": "string|null",// optional
  "status": "Pendiente|Completado|..." // required (POST)
}
```

Campos controlados por la DB (no enviar en POST): `created_at`, `id` (si DB genera autoincrement).

---

### 5. Cabeceras obligatorias
- Content-Type: application/json
- Authorization: Bearer <SERVICE_ROLE_KEY> (o la clave que uses para la funci√≥n)

---

### 6. M√©todos soportados (CRUD) y ejemplos

- Leer todos los pagos ‚Äî GET  
  Request: GET sin body  
  Respuesta: 200 OK ‚Äî JSON array de objetos `payment`.

  Ejemplo curl:
  ```bash
  curl -X GET "https://<PROJECT_REF>.supabase.co/functions/v1/payments-crud" \
    -H "Authorization: Bearer <SERVICE_ROLE_KEY>"
  ```

- Crear un pago ‚Äî POST  
  Request: JSON con campos necesarios. Respuesta: 201 Created

  Body ejemplo:
  ```json
  {
    "projectId": 1,
    "amount": 40.00,
    "payment_date": "2025-11-01",
    "details": "Pago inicial de la factura 1234",
    "status": "Pendiente"
  }
  ```

  Ejemplo curl:
  ```bash
  curl -X POST "https://<PROJECT_REF>.supabase.co/functions/v1/payments-crud" \
    -H "Authorization: Bearer <SERVICE_ROLE_KEY>" \
    -H "Content-Type: application/json" \
    -d '{"projectId":1,"amount":40,"payment_date":"2025-11-01","details":"Pago inicial","status":"Pendiente"}'
  ```

- Actualizar un pago ‚Äî PUT  
  Request: JSON que incluya `id` y los campos a actualizar. Respuesta: 200 OK

  Body ejemplo:
  ```json
  {
    "id": 42,
    "amount": 60.50,
    "status": "Completado"
  }
  ```

  Ejemplo curl:
  ```bash
  curl -X PUT "https://<PROJECT_REF>.supabase.co/functions/v1/payments-crud" \
    -H "Authorization: Bearer <SERVICE_ROLE_KEY>" \
    -H "Content-Type: application/json" \
    -d '{"id":42,"amount":60.5,"status":"Completado"}'
  ```

- Eliminar un pago ‚Äî DELETE  
  Request: JSON con `id`. Respuesta: 200 OK

  Body ejemplo:
  ```json
  { "id": 42 }
  ```

  Ejemplo curl:
  ```bash
  curl -X DELETE "https://<PROJECT_REF>.supabase.co/functions/v1/payments-crud" \
    -H "Authorization: Bearer <SERVICE_ROLE_KEY>" \
    -H "Content-Type: application/json" \
    -d '{"id":42}'
  ```

---

### 7. Errores comunes y soluci√≥n r√°pida
- "Unexpected end of JSON input": el body de la request est√° vac√≠o o no es JSON v√°lido.  
  - Verifica que `Content-Type: application/json` est√© presente.  
  - Asegura que el body no est√© vac√≠o y sea JSON v√°lido (Thunder Client ‚Üí Body ‚Üí Raw JSON).

- Errores de import/permiso en el deploy: a√±ade `--allow-env` y `--allow-net` al comando de deploy, o evita importaciones desde CDNs que requieran permiso de red.

---

### 8. Buenas pr√°cticas
- No exponer `SUPABASE_SERVICE_ROLE_KEY` en el frontend.  
- Validar entradas en la funci√≥n antes de ejecutar queries.  
- Registrar acciones cr√≠ticas en la tabla `logs` (si procede).