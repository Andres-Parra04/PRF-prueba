# FinReport Pro — Plataforma de Reportes Financieros

Aplicación web (SPA) para la gestión de clientes y la generación de reportes financieros. Incluye un panel de administración (CRUD) y un dashboard de cliente con acceso mediante enlaces temporales.

- Demo local: abrir index.html en el navegador
- Tecnologías: HTML, Tailwind CSS, JavaScript, Supabase (Edge Functions)

---

## Tabla de Contenidos

- [Estructura del Proyecto](#estructura-del-proyecto)
- [Comenzar](#comenzar)
- [Uso](#uso)
- [Características](#características)
- [Notas de Seguridad](#notas-de-seguridad)
- [Changelog](#changelog)
- [Bugs Críticos Conocidos](#bugs-críticos-conocidos)
- [Tareas Pendientes](#tareas-pendientes)
- [Base de Datos (DDL)](#base-de-datos-ddl)
  - [Tablas](#tablas)
  - [Relaciones (FK)](#relaciones-fk)
- [Documentación de API (Edge Functions)](#documentación-de-api-edge-functions)
  - [Autenticación y Cabeceras](#autenticación-y-cabeceras)
  - [Variables de Entorno](#variables-de-entorno)
  - [Despliegue (CLI Supabase)](#despliegue-cli-supabase)
  - [Endpoints](#endpoints)
- [Solución de Problemas](#solución-de-problemas)
- [Contribuir](#contribuir)
- [Licencia](#licencia)

---

## Estructura del Proyecto

```text
financial-reports-app
├── css
│   └── style.css        # Estilos de la aplicación
├── js
│   └── script.js        # Lógica del cliente (SPA)
├── index.html           # HTML principal
└── README.md            # Documentación
```

---

## Comenzar

### Requisitos
- Navegador moderno (Chrome, Firefox, Edge, Safari)
- Conocimientos básicos de HTML, CSS, JavaScript

### Instalación
1. Clona el repositorio o descarga los archivos.
2. Abre el archivo index.html en tu navegador.

---

## Uso

- Acceso Admin (demo):
  - Usuario: admin@finreport.co
  - Contraseña: password123
- Dashboard de Cliente: acceso a través de un enlace temporal con token generado por el admin.

---

## Características

- Panel de administración con CRUD de Clientes.
- Generación de tokens de acceso temporal para clientes.
- Dashboard del cliente con proyectos, pagos y resumen financiero.
- Diseño responsive (Tailwind CSS).
- Impresión/exportación a PDF del reporte.

---

## Notas de Seguridad

- Las credenciales incluidas son solo para desarrollo/demostración.
- Reemplazar la codificación Base64 por JWT firmados al pasar a producción.
- No exponer nunca la SUPABASE_SERVICE_ROLE_KEY en el cliente.

---

## Changelog

### v1.0.1 — 2025-10-31
- Fix: En el panel de administración, las vistas de “Proyectos” y “Pagos” ya no muestran JSON crudo; ahora renderizan tablas formateadas.

### v1.0.0 — 2025-10-31
- Refactor: Separación en index.html, css/style.css y js/script.js.
- Funcionalidad base:
  - Autenticación de administradores.
  - CRUD de Clientes (básico).
  - Tokens de acceso temporal (simulados con Base64).
  - Dashboard de cliente (proyectos, pagos, resumen).
  - Logging de acciones clave.
  - Impresión/Generación de PDF del reporte.

---

## Bugs Críticos Conocidos

- No hay bugs críticos conocidos actualmente.

---

## Tareas Pendientes

### Backend y Seguridad
- [ ] Backend real (Node.js/Python) con base de datos.
- [ ] JWT firmados en lugar de Base64.
- [ ] Endpoints de API seguros para CRUD.

### Funcionalidades del Administrador
- [ ] CRUD completo para Proyectos.
- [ ] CRUD completo para Pagos.
- [ ] Filtros y búsqueda en tablas.
- [ ] Paginación en listados.

### Funcionalidades del Cliente
- [ ] Integrar pasarela de pagos (Stripe/PayPal).
- [ ] Descarga de facturas en PDF.
- [ ] Mejoras UI con gráficos (Chart.js).

### Mejora General
- [ ] Pruebas unitarias (autenticación, cálculos).
- [ ] Validación robusta de formularios (cliente/servidor).

---

## Base de Datos (DDL)

Nota: Ajusta tipos (bigint/uuid) y nombres de columnas según tu esquema final. Columnas entre comillas son sensibles a mayúsculas/minúsculas.

### Tablas

1) clients

```sql
CREATE TABLE public.clients (
  id bigint PRIMARY KEY GENERATED BY DEFAULT AS IDENTITY,
  name varchar NOT NULL,
  email varchar NOT NULL,
  created_at timestamptz DEFAULT timezone('utc'::text, now()),
  updated_at timestamptz
);
```

2) projects

```sql
CREATE TABLE public.projects (
  id bigint PRIMARY KEY GENERATED BY DEFAULT AS IDENTITY,
  "clientId" bigint,
  name varchar NOT NULL,
  description text,
  "totalValue" numeric NOT NULL,
  status text NOT NULL DEFAULT 'activo'::text,
  start_date date,
  end_date date,
  created_at timestamptz DEFAULT timezone('utc'::text, now()),
  updated_at timestamptz
);
```

3) payments

```sql
CREATE TABLE public.payments (
  id bigint PRIMARY KEY GENERATED BY DEFAULT AS IDENTITY,
  "projectId" bigint,
  amount numeric NOT NULL,
  payment_date date NOT NULL,
  status varchar NOT NULL DEFAULT 'revisión'::varchar,
  details text,
  created_at timestamptz DEFAULT timezone('utc'::text, now())
);
```

4) access_tokens

```sql
CREATE TABLE public.access_tokens (
  token_id bigint PRIMARY KEY GENERATED BY DEFAULT AS IDENTITY,
  client_id bigint,
  token_value text NOT NULL,
  expires_at timestamptz NOT NULL,
  created_at timestamptz DEFAULT timezone('utc'::text, now())
);
```

5) logs

```sql
CREATE TABLE public.logs (
  log_id bigint PRIMARY KEY GENERATED BY DEFAULT AS IDENTITY,
  user_id text,
  action_type varchar NOT NULL,
  description text,
  "timestamp" timestamptz DEFAULT timezone('utc'::text, now())
);
```

### Relaciones (FK)

| Relación | Origen | Referencia | ON DELETE | Descripción |
| --- | --- | --- | --- | --- |
| Projects → Clients | projects."clientId" | clients.id | SET NULL | Un proyecto puede quedar sin cliente. |
| Payments → Projects | payments."projectId" | projects.id | SET NULL | Un pago puede persistir sin su proyecto (con projectId nulo). |
| Access Tokens → Clients | access_tokens.client_id | clients.id | CASCADE | Al borrar un cliente se borran sus tokens. |

#### DDL de restricciones

```sql
ALTER TABLE public.projects
ADD CONSTRAINT fk_client
FOREIGN KEY ("clientId")
REFERENCES public.clients(id)
ON DELETE SET NULL;

ALTER TABLE public.payments
ADD CONSTRAINT fk_project_payment
FOREIGN KEY ("projectId")
REFERENCES public.projects(id)
ON DELETE SET NULL;

ALTER TABLE public.access_tokens
ADD CONSTRAINT fk_client_token
FOREIGN KEY (client_id)
REFERENCES public.clients(id)
ON DELETE CASCADE;
```

---

## Documentación de API (Edge Functions)

### Autenticación y Cabeceras

1) Funciones de Administrador (server-to-server)
- Funciones: clients-crud, projects-crud, payments-crud, generate-client-link, logs-reader
- Header obligatorio: Authorization: Bearer <SUPABASE_SERVICE_ROLE_KEY>
- Content-Type: application/json (en POST/PUT/DELETE)

2) Función Pública (cliente final)
- Función: get-client-data
- Sin Authorization; valida token temporal (UUID) en el body de la request POST.

### Variables de Entorno
- SUPABASE_URL
- SUPABASE_SERVICE_ROLE_KEY

### Despliegue (CLI Supabase)

```bash
supabase functions deploy <function-name> \
  --no-verify-jwt \
  --allow-env \
  --allow-net="<PROJECT_REF>.supabase.co,esm.sh"
```

Nota: Se usa esm.sh porque las funciones importan el cliente de Supabase desde ese host.

---

## Endpoints

Ajusta tipos de id (bigint o uuid) y nombres de campos para que coincidan con tu esquema real.

### clients-crud (CRUD de Clientes)
- Endpoint: https://<PROJECT_REF>.supabase.co/functions/v1/clients-crud
- Métodos: GET, POST, PUT, DELETE
- Auth: Authorization: Bearer <SERVICE_ROLE_KEY>

Objeto client (ejemplo):
```json
{
  "id": 1,
  "name": "Cliente Ejemplo",
  "email": "cliente@ejemplo.com"
}
```

- GET (leer todos):
```bash
curl -X GET "https://<PROJECT_REF>.supabase.co/functions/v1/clients-crud" \
  -H "Authorization: Bearer <SERVICE_ROLE_KEY>"
```

- POST (crear):
```bash
curl -X POST "https://<PROJECT_REF>.supabase.co/functions/v1/clients-crud" \
  -H "Authorization: Bearer <SERVICE_ROLE_KEY>" \
  -H "Content-Type: application/json" \
  -d '{"name":"Cliente Ejemplo","email":"cliente@ejemplo.com"}'
```

- PUT (actualizar):
```bash
curl -X PUT "https://<PROJECT_REF>.supabase.co/functions/v1/clients-crud" \
  -H "Authorization: Bearer <SERVICE_ROLE_KEY>" \
  -H "Content-Type: application/json" \
  -d '{"id":1,"name":"Nombre Actualizado"}'
```

- DELETE (eliminar):
```bash
curl -X DELETE "https://<PROJECT_REF>.supabase.co/functions/v1/clients-crud" \
  -H "Authorization: Bearer <SERVICE_ROLE_KEY>" \
  -H "Content-Type: application/json" \
  -d '{"id":1}'
```

---

### projects-crud (CRUD de Proyectos)
- Endpoint: https://<PROJECT_REF>.supabase.co/functions/v1/projects-crud
- Métodos: GET, POST, PUT, DELETE
- Auth: Authorization: Bearer <SERVICE_ROLE_KEY>

Objeto project (ejemplo):
```json
{
  "id": 10,
  "clientId": 1,
  "name": "Nuevo Sitio Web",
  "total_cost": 5000,
  "status": "Activo"
}
```

- GET:
```bash
curl -X GET "https://<PROJECT_REF>.supabase.co/functions/v1/projects-crud" \
  -H "Authorization: Bearer <SERVICE_ROLE_KEY>"
```

- POST:
```bash
curl -X POST "https://<PROJECT_REF>.supabase.co/functions/v1/projects-crud" \
  -H "Authorization: Bearer <SERVICE_ROLE_KEY>" \
  -H "Content-Type: application/json" \
  -d '{"clientId":1,"name":"Nuevo Sitio Web","total_cost":5000,"status":"Activo"}'
```

- PUT:
```bash
curl -X PUT "https://<PROJECT_REF>.supabase.co/functions/v1/projects-crud" \
  -H "Authorization: Bearer <SERVICE_ROLE_KEY>" \
  -H "Content-Type: application/json" \
  -d '{"id":10,"status":"Cerrado"}'
```

- DELETE:
```bash
curl -X DELETE "https://<PROJECT_REF>.supabase.co/functions/v1/projects-crud" \
  -H "Authorization: Bearer <SERVICE_ROLE_KEY>" \
  -H "Content-Type: application/json" \
  -d '{"id":10}'
```

---

### payments-crud (CRUD de Pagos)
- Endpoint: https://<PROJECT_REF>.supabase.co/functions/v1/payments-crud
- Métodos: GET, POST, PUT, DELETE
- Auth: Authorization: Bearer <SERVICE_ROLE_KEY>

Objeto payment (ejemplo):
```json
{
  "id": 42,
  "projectId": 10,
  "amount": 40,
  "payment_date": "2025-11-01",
  "details": "Pago inicial",
  "status": "Pendiente"
}
```

- GET:
```bash
curl -X GET "https://<PROJECT_REF>.supabase.co/functions/v1/payments-crud" \
  -H "Authorization: Bearer <SERVICE_ROLE_KEY>"
```

- POST:
```bash
curl -X POST "https://<PROJECT_REF>.supabase.co/functions/v1/payments-crud" \
  -H "Authorization: Bearer <SERVICE_ROLE_KEY>" \
  -H "Content-Type: application/json" \
  -d '{"projectId":10,"amount":40,"payment_date":"2025-11-01","details":"Pago inicial","status":"Pendiente"}'
```

- PUT:
```bash
curl -X PUT "https://<PROJECT_REF>.supabase.co/functions/v1/payments-crud" \
  -H "Authorization: Bearer <SERVICE_ROLE_KEY>" \
  -H "Content-Type: application/json" \
  -d '{"id":42,"amount":60.5,"status":"Completado"}'
```

- DELETE:
```bash
curl -X DELETE "https://<PROJECT_REF>.supabase.co/functions/v1/payments-crud" \
  -H "Authorization: Bearer <SERVICE_ROLE_KEY>" \
  -H "Content-Type: application/json" \
  -d '{"id":42}'
```

---

### generate-client-link (Generar enlace de acceso)
- Endpoint: https://<PROJECT_REF>.supabase.co/functions/v1/generate-client-link
- Método: POST
- Auth: Authorization: Bearer <SERVICE_ROLE_KEY>

Body:
```json
{ "client_id": 1 }
```

Respuesta (201):
```json
{ "token": "uuid-generado-como-token" }
```

Ejemplo:
```bash
curl -X POST "https://<PROJECT_REF>.supabase.co/functions/v1/generate-client-link" \
  -H "Authorization: Bearer <SERVICE_ROLE_KEY>" \
  -H "Content-Type: application/json" \
  -d '{"client_id":1}'
```

---

### logs-reader (Lectura de logs)
- Endpoint: https://<PROJECT_REF>.supabase.co/functions/v1/logs-reader
- Método: GET
- Auth: Authorization: Bearer <SERVICE_ROLE_KEY>

Respuesta (200):
```json
[
  {
    "created_at": "2025-10-31T12:00:00Z",
    "action": "Generated access link for client ...",
    "user": { "email": "admin@ejemplo.com" }
  }
]
```

```bash
curl -X GET "https://<PROJECT_REF>.supabase.co/functions/v1/logs-reader" \
  -H "Authorization: Bearer <SERVICE_ROLE_KEY>"
```

---

## Edge Function: `get-client-data`

Esta función de Supabase sirve como un endpoint público y seguro para que los clientes puedan ver sus reportes financieros a través de un enlace temporal.

### Flujo de Operación

1.  **Recepción de Token**: La función espera una petición `POST` con un token de acceso temporal en el cuerpo (body).
2.  **Manejo de CORS**: La función está configurada para manejar peticiones Cross-Origin (CORS) desde cualquier origen (`*`). Responde correctamente a las peticiones de pre-vuelo `OPTIONS` del navegador, lo cual es crucial para que las aplicaciones web de front-end puedan consumirla.
3.  **Validación de Token**:
    *   Busca el token en la tabla `access_tokens`.
    *   Verifica que el token exista y no haya expirado.
    *   Si el token es inválido o ha expirado, devuelve un error `401 Unauthorized`.
4.  **Obtención de Datos**:
    *   Si el token es válido, extrae el `client_id` asociado.
    *   Invoca la función de base de datos PostgreSQL `get_client_dashboard_data(client_id)`.
5.  **Función RPC (`get_client_dashboard_data`)**:
    *   Esta función de base de datos recibe el `client_id` (de tipo `bigint`).
    *   Consulta las tablas `clients`, `projects` y `payments` para recopilar toda la información del cliente.
    *   Calcula los totales (`total_paid` y `total_pending`), manejando correctamente los nombres de columna con mayúsculas como `"totalValue"` para evitar errores.
    *   Agrupa todos los datos en un único objeto JSON.
6.  **Respuesta Final**: La Edge Function devuelve el objeto JSON completo con un estado `200 OK` y las cabeceras CORS correspondientes.

---

### Detalles del Endpoint

-   **Endpoint**: `https://<PROJECT_REF>.supabase.co/functions/v1/get-client-data`
-   **Método**: `POST`
-   **Auth**: Pública. La autorización se maneja internamente a través del token en el body.

#### Body de la Petición

```json
{
  "token": "uuid-del-link-temporal"
}
```

#### Respuesta Exitosa (200 OK)

Devuelve un objeto JSON que contiene los datos del cliente, sus proyectos, pagos y los totales calculados.

```json
{
  "client": { "id": 1, "name": "..." },
  "projects": [ { "id": 10, "name": "...", "totalValue": 1000, "status": "Activo" } ],
  "payments": [ { "id": 42, "amount": 500, "projectId": 10, "status": "Completado" } ],
  "totals": { "total_paid": 500, "total_pending": 500 }
}
```

#### Respuestas de Error

-   **401 Unauthorized**: Si el token es inválido o ha expirado.
    ```json
    { "error": "Acceso inválido o expirado." }
    ```
-   **400 Bad Request**: Si ocurre un error interno, como un problema con la función RPC. El mensaje de error detallado se incluye para facilitar la depuración.
    ```json
    { "error": "RPC error: <detalle del error>" }
    ```

#### Ejemplo de uso con cURL

```bash
curl -X POST "https://<PROJECT_REF>.supabase.co/functions/v1/get-client-data" \
  -H "Content-Type: application/json" \
  -H "apikey: <SUPABASE_ANON_KEY>" \
  -d '{"token":"uuid-del-link-temporal"}'
```


---

## Solución de Problemas

- Error: Unexpected end of JSON input
  - Causa: Body vacío o JSON inválido.
  - Solución: Añade Content-Type: application/json y body válido.

- Errores de permisos en deploy (Deno)
  - Causa: Faltan permisos de env/net.
  - Solución: Usa --allow-env y --allow-net en el deploy (ver sección de despliegue).

- {"error":"Acceso inválido o expirado."} (get-client-data)
  - Causa: Token incorrecto o expirado.
  - Solución: Generar un nuevo enlace desde el panel de admin.

---

## Contribuir

Los PRs y issues son bienvenidos. Abre un issue para discutir cambios mayores.

---

## Licencia

MIT. Ver el archivo LICENSE.